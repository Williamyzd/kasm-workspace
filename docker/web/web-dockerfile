FROM registry.cn-hangzhou.aliyuncs.com/reg_pub/kasmweb_desktop:1.9.0 
USER root
# ARG APP_DIR=/app    
# mcp 
# 定义环境变量
ENV UV_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
ENV EXTRA_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
ENV UV_DEFAULT_INDEX=https://pypi.tuna.tsinghua.edu.cn/simple
ENV UV_PYTHON_INSTALL_MIRROR=https://mirror.nju.edu.cn/github-release/indygreg/python-build-standalone/
ENV WEB_DIR=/app
ENV MCP_CONFIG=$WEB_DIR/config 
ENV BROWER_USER_DIR=$WEB_DIR/brower-user-dir  
ENV WEB_PYTHON_ENV=$WEB_DIR/mcp-env
ENV WEB_LOG=$WEB_DIR/log


RUN mkdir -p ${BROWER_USER_DIR} && \
    mkdir -p $WEB_LOG && \
    mkdir -p $MCP_CONFIG 

COPY start.sh        ${WEB_DIR}/
COPY config.json     ${MCP_CONFIG}/
COPY setup_20.x      ${MCP_CONFIG}/nodesource_setup.sh   

# 安装nodejs和pip
# 
RUN chmod +x ${MCP_CONFIG}/nodesource_setup.sh && \
    chmod +x ${WEB_DIR}/start.sh && \
    bash ${MCP_CONFIG}/nodesource_setup.sh && apt-get update && \
    apt-get install -y --no-install-recommends nodejs python3-pip && \
    pip config set global.index-url $UV_INDEX_URL && \
    pip config set global.extra-index-url $EXTRA_INDEX_URL && \
    python3 -m pip install --upgrade pip && \
    rm -rf /var/lib/apt/lists/* && rm -f ${MCP_CONFIG}/nodesource_setup.sh
RUN pip install uv  && \
uv venv $WEB_PYTHON_ENV --python 3.12  && \
. $WEB_PYTHON_ENV/bin/activate && \
uv pip install playwright mcpo && \
echo "/app/start.sh &" >> /dockerstartup/custom_startup.sh


RUN chown 1000:0 $WEB_DIR
RUN $STARTUPDIR/set_user_permission.sh $WEB_DIR

USER 1000
CMD ${WEB_DIR}/start.sh 
